# Gopper ü¶´

A Klipper firmware implementation in TinyGo for modern microcontrollers.

Gopper brings the power of Go to 3D printer firmware, providing a modern, type-safe, and maintainable alternative to C-based implementations while maintaining full compatibility with the Klipper protocol.

## Features (Planned)

- Full Klipper protocol compatibility
- Written in TinyGo for optimal embedded performance
- Modular architecture for easy customization
- Type-safe implementation with Go's strong typing
- Support for modern microcontrollers (RP2040, STM32, etc.)

## Status

‚ö†Ô∏è **Early Development** - This project is in active development and not yet ready for production use.

### Current Progress

**Phase 1: Core Protocol (Completed ‚úÖ)**
- ‚úÖ VLQ encoding/decoding (Klipper-compatible)
- ‚úÖ CRC16 implementation
- ‚úÖ Buffer management (InputBuffer, OutputBuffer, FifoBuffer)
- ‚úÖ Transport layer with message framing
- ‚úÖ Command dispatch system
- ‚úÖ Unit tests for all components

**Phase 2: Minimum Viable Commands (Completed ‚úÖ)**
- ‚úÖ Data dictionary generation system
- ‚úÖ Constants and enumerations registry
- ‚úÖ Core protocol commands:
  - `identify` / `identify_response`
  - `get_uptime` / `uptime`
  - `get_clock` / `clock`
  - `get_config` / `config`
  - `config_reset`
  - `finalize_config`
  - `allocate_oids`
  - `emergency_stop`
- ‚úÖ RP2040 hardware timer integration
- ‚úÖ USB CDC communication (native USB support)
- ‚úÖ Complete main loop with USB I/O

**Phase 3: Stepper Control (Next)**
- ‚è≥ Stepper driver infrastructure
- ‚è≥ Step pulse generation
- ‚è≥ Queue-based motion planning
- ‚è≥ Endstop handling

## Supported Hardware (Planned)

- RP2040 (Raspberry Pi Pico)
- STM32F4 series
- STM32H7 series
- More to come...

## Communication

Gopper uses **native USB CDC (Communications Device Class)** for communication with the Klipper host. This provides:

When you flash Gopper to your board, it will enumerate as a USB serial device:
- **Linux**: `/dev/ttyACM0`
- **macOS**: `/dev/tty.usbmodem*`
- **Windows**: `COM3` (or similar)


## Project Structure
```
gopper/
‚îú‚îÄ‚îÄ protocol/      # Klipper protocol implementation
‚îú‚îÄ‚îÄ core/          # Core scheduling and command system
‚îú‚îÄ‚îÄ hardware/      # Hardware abstraction layer
‚îú‚îÄ‚îÄ motion/        # Motion control and kinematics
‚îú‚îÄ‚îÄ modules/       # Peripheral modules (steppers, sensors, etc.)
‚îú‚îÄ‚îÄ targets/       # Target-specific implementations
‚îî‚îÄ tinycompress/  # TinyCompress compression library (zlib compatible)
```

## Building

Requirements:
- TinyGo 0.31.0 or later
- Go 1.21 or later

```bash
# Build for RP2040 (Raspberry Pi Pico)
make rp2040

# Build for RP2350 (Raspberry Pi Pico 2)
tinygo build -target=pico2 -o build/gopper-rp2350.uf2 ./targets/rp2040

# Build for STM32F4
make stm32f4

# Run tests
make test

# Clean build artifacts
make clean
```

### Manual Build Commands

```bash
# Build for RP2040
tinygo build -target=pico -o build/gopper-rp2040.uf2 ./targets/rp2040

# Build for RP2350
tinygo build -target=pico2 -o build/gopper-rp2350.uf2 ./targets/rp2040

# Build for STM32F4
tinygo build -target=nucleo-f446re -o build/gopper-stm32f4.hex ./targets/stm32f4

# Run tests
go test ./protocol/... ./core/...
```

## Testing with Klipper


Test protocol without any Klipper installation:

```bash
# 1. Install Klipper (if not using Docker)
git clone https://github.com/Klipper3d/klipper
cd klipper && ./scripts/install-octopi.sh

# 2. Flash firmware
cp build/gopper-rp2040.uf2 /media/$USER/RPI-RP2/
#copy the uf2 to the RP2040 in Bootsel mode

# or use this command to flash directly from the RP2040
tinygo flash -target=pico -port=/dev/ttyACM0 build/gopper-rp2040.uf2

# 3. Configure and run Klipper
cp test/klipper-test.cfg ~/printer.cfg
~/klipper/klippy/klippy.py ~/printer.cfg -l /tmp/klippy.log
```

See [test/README.md](test/README.md) for detailed testing instructions and troubleshooting.

## Contributing

Contributions are welcome! Please see [CONTRIBUTING.md](CONTRIBUTING.md) for guidelines.

## Acknowledgments

- [Klipper](https://github.com/Klipper3d/klipper) by Kevin O'Connor
- [Anchor](https://github.com/Annex-Engineering/anchor) for inspiration on protocol implementation
- The TinyGo community

## License

MIT License - See [LICENSE](LICENSE) for details